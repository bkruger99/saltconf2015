{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "This CloudFormation template will instantiate an S3 bucket and the IAM role to access the bucket.  This ensures that a permanent data storage is available",

  "Parameters" : {

    "BucketName" : {
      "Description" : "Name of a new s3 bucket to create",
      "Type" : "String",
      "MinLength": "1",
      "MaxLength": "128",
      "AllowedPattern" : "[-_ a-zA-Z0-9]*",
      "ConstraintDescription" : "can contain only alphanumeric characters, spaces, dashes and underscores.",
      "Default" : "saltconf2015"
    }

  },

  "Mappings" : {
  },

  "Resources" : {

   "SaltConf2015Bucket": {
     "Type" : "AWS::S3::Bucket",
     "Properties" : {
       "AccessControl" : "Private",
       "BucketName" : { "Ref" : "BucketName"},
       "Tags" : [ 
                 { "Key" : "Purpose", "Value" :  "SaltConf2015" }
                ]
      }
    },

  "S3SaltConf2015Role": {
         "Type": "AWS::IAM::Role",
         "Properties": {
            "AssumeRolePolicyDocument": {
               "Version" : "2012-10-17",
               "Statement": [ {
                  "Effect": "Allow",
                  "Principal": {
                     "Service": [ "ec2.amazonaws.com" ]
                  },
                  "Action": [ "sts:AssumeRole" ]
               } ]
            },
            "Path": "/",
            "Policies": [ {
               "PolicyName": "saltconf2015role",
               "PolicyDocument": {
                  "Version" : "2012-10-17",
                  "Statement": [ 
                    {
                     "Effect": "Allow",
                     "Action": "s3:*",
                     "Resource": ["arn:aws:s3:::saltconf2015bucket",
                                  "arn:aws:s3:::saltconf2015bucket/*"]
                    },
                    {"Effect": "Allow",
                     "Action": "s3:ListAllMyBuckets",
                     "Resource": "arn:aws:s3:::*"
                    },
                    {
                      "Action": [
                        "ec2:AssociateAddress",
                        "ec2:DisassociateAddress"
                      ],
                      "Effect": "Allow",
                      "Resource": "*"
                    }
                 ]
               }
               } ]
            }
   },
   "S3SaltConf2015InstanceProfile": {
         "Type": "AWS::IAM::InstanceProfile",
         "Properties": {
            "Path": "/",
            "Roles": [ {
               "Ref": "S3SaltConf2015Role"
            } ]
         }
   },

  "S3GroupPolicy1" : {
    "Type" : "AWS::IAM::Policy",
    "Properties" : {
      "Groups" : [ { "Ref" : "SaltConf2015Group" } ],
      "PolicyName" : "saltconfs3bucketpolicy",
      "PolicyDocument" : {
         "Version" : "2012-10-17",
         "Statement": [ 
          {
            "Effect": "Allow",
            "Action": [ "s3:*" ],
            "Resource": ["arn:aws:s3:::saltconf2015bucket", "arn:aws:s3:::saltconf2015bucket/*"]
          },
          {"Effect": "Allow",
            "Action": [ "s3:ListAllMyBuckets" ],
            "Resource": "arn:aws:s3:::*"
          }
         ]
      }
   }
  },
  "SaltConf2015Group": {
    "Type" : "AWS::IAM::Group",
    "Properties": {
      "Path": "/"
    }
  },

  "saltconf2015user" : {
   "Type" : "AWS::IAM::User",
   "Properties" : {
      "Path" : "/",
      "Groups" : [ {"Ref": "SaltConf2015Group"} ],
      "LoginProfile" : {
         "Password" : "s3cr3tpassword"
      }
    }
  },

  "saltconf2015accesskey" : {
    "Type" : "AWS::IAM::AccessKey",
    "Properties" : {
      "UserName" : { "Ref" : "saltconf2015user" }
   }
  } 

},
  
  "Outputs" : {
   "S3SaltConf2015Bucket" : {
      "Value" : { "Fn::Join" : [
         "", [ "https://", { "Fn::GetAtt" : [ "SaltConf2015Bucket", "DomainName" ] } ]
      ] },
      "Description" : "Name of S3 bucket for saltconf 2015 demo"
   },
   "S3SaltConf2015Role" : {
      "Value" : { "Ref": "S3SaltConf2015Role"},
      "Description" : "Reference name of S3SaltConf2015Role"
   },
   "S3SaltConf2015RoleArn" : {
      "Value" :  {"Fn::GetAtt" : ["S3SaltConf2015Role", "Arn"] },
      "Description" : "AWS ARN of S3SaltConf2015Role"
   },
   "S3SaltConf2015InstanceProfile" : {
      "Value" : { "Ref" : "S3SaltConf2015InstanceProfile"},
      "Description" : "Reference name of S3SaltConf2015InstanceProfile"
   },
   "S3SaltConf2015InstanceArn" : {
      "Value" :  {"Fn::GetAtt" : ["S3SaltConf2015InstanceProfile", "Arn"] },
      "Description" : "AWS ARN of S3SaltConf2015InstanceProfile"
   },
   "SaltConf2015User" : {
      "Value" :  { "Ref" : "saltconf2015user"},
      "Description" : "User account for manipulating bucket"
   },
   "AccessKeyforsaltconf2015user" : {
      "Value" : { "Ref" : "saltconf2015accesskey" }
   },
   "SecretKeyforsaltconf2015useraccesskey" : {
      "Value" : {
      "Fn::GetAtt" : [ "saltconf2015accesskey", "SecretAccessKey" ]
   }
} 
 }

}
